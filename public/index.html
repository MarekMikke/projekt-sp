<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="mini-logo.png">
  <title>Strona główna - Monitoring temperatury i wilgotności</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>System monitoringu temperatury i wilgotności</h1>
    <nav>
      <ul>
        <li><a href="index.html">Strona główna</a></li>
        <li><a href="czujniki.html">Dostępne urządzenia</a></li>
        <li><a href="dane.html">Dane pomiarowe</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Sekcja dynamicznych odczytów z Firebase Realtime Database -->
    <section class="dynamic-content-section">
      <h2>Bieżące Odczyty z Pomieszczeń</h2>
      <div id="rooms-data">
        <p>Ładowanie danych o bieżących odczytach...</p>
      </div>
    </section>

    <!-- Sekcja statusu użytkownika i linków do zarządzania -->
    <section class="auth-section">
      <h3>Status Użytkownika</h3>
      <p id="auth-status">Sprawdzanie statusu...</p>
      <a href="login.html" id="login-link" class="nav-link" style="display: none;">Zaloguj się</a>
      <button id="logout-button" style="display: none;">Wyloguj</button>
      <p><a href="config.html" class="nav-link">Przejdź do Konfiguracji Progów</a></p>
    </section>

    <!-- Sekcja "O projekcie" z Twojej poprzedniej wersji -->
    <section>
      <h2>O projekcie</h2>
      <p>Ten system wykorzystuje ESP32 do monitorowania warunków w pomieszczeniach. Czujniki przesyłają dane przez Wi-Fi do bazy Firebase, a Ty możesz je śledzić na tej stronie.</p>
      <img src="esp32.jpg" alt="ESP32 z czujnikiem" width="400">
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Marek – Projekt SP</p>
  </footer>


  <!-- Firebase SDK Scripts -->
  <script type="module">
				// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
		  apiKey: "AIzaSyAJB3DxLtFFOvC2OpTxLAbpr4rJUfCyOwo",
		  authDomain: "projekt-sp.firebaseapp.com",
		  databaseURL: "https://projekt-sp-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "projekt-sp",
		  storageBucket: "projekt-sp.firebasestorage.app",
		  messagingSenderId: "485520309533",
		  appId: "1:485520309533:web:cbf484593a3df15c58f5f4",
		  measurementId: "G-STCT52Y98E"
		};

        // 2. Importowanie niezbędnych modułów Firebase
        // Zmienione ścieżki importu na bezpośrednie z CDN!
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

        // 3. Inicjalizacja Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // 4. Pobieranie referencji do elementów UI
        const roomsContainer = document.getElementById('rooms-data');
        const authStatusElement = document.getElementById('auth-status');
        const loginLink = document.getElementById('login-link');
        const logoutButton = document.getElementById('logout-button');

        // 5. Nasłuchiwanie na bieżące odczyty z Realtime Database
        const currentReadingsRef = ref(database, 'currentReadings');
        onValue(currentReadingsRef, (snapshot) => {
          roomsContainer.innerHTML = ''; // Czyścimy poprzednie dane przed wstawieniem nowych
          const data = snapshot.val(); // Pobieramy wszystkie bieżące odczyty z /currentReadings
          if (data) {
            Object.keys(data).forEach(roomName => {
              const roomData = data[roomName];
              // Formatujemy timestamp do czytelnej daty i godziny
              const timestamp = roomData.timestamp ? new Date(roomData.timestamp).toLocaleString() : 'Brak danych';
              
              const roomElement = document.createElement('div');
              roomElement.classList.add('room-card');
              roomElement.innerHTML = `
                <h3>${roomName}</h3>
                <p><strong>Temperatura:</strong> ${roomData.temperatura !== undefined ? roomData.temperatura + ' °C' : 'N/A'}</p>
                <p><strong>Wilgotność:</strong> ${roomData.wilgotnosc !== undefined ? roomData.wilgotnosc + ' %' : 'N/A'}</p>
                <p><strong>Ostatnia aktualizacja:</strong> ${timestamp}</p>
              `;
              roomsContainer.appendChild(roomElement);
            });
          } else {
            roomsContainer.innerHTML = '<p>Brak danych o bieżących odczytach z pomieszczeń.</p>';
          }
        });

        // 6. Nasłuchiwanie na zmiany statusu uwierzytelnienia (login/logout)
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // Użytkownik zalogowany
            authStatusElement.textContent = `Zalogowano jako: ${user.email}`;
            loginLink.style.display = 'none'; // Ukrywamy link do logowania
            logoutButton.style.display = 'inline-block'; // Pokazujemy przycisk wylogowania
          } else {
            // Użytkownik niezalogowany
            authStatusElement.textContent = 'Niezalogowano';
            loginLink.style.display = 'inline-block'; // Pokazujemy link do logowania
            logoutButton.style.display = 'none'; // Ukrywamy przycisk wylogowania
          }
        });

        // 7. Funkcja wylogowania
        logoutButton.addEventListener('click', () => {
          signOut(auth).then(() => {
            alert('Wylogowano pomyślnie!'); // Proste powiadomienie dla użytkownika
            // Można też przekierować na stronę główną lub logowania
            window.location.href = 'index.html'; 
          }).catch((error) => {
            console.error('Błąd wylogowania:', error);
            alert('Błąd wylogowania: ' + error.message);
          });
        });
    </script>

</body>
</html>
