<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dane pomiarowe</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
  <header>
    <h1>Dane pomiarowe</h1>
    <nav>
      <ul>
        <li><a href="index.html">Strona główna</a></li>
        <li><a href="czujniki.html">Dostępne urządzenia</a></li>
        <li><a href="dane.html">Dane pomiarowe</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>Wybierz czujnik</h2>
    <select id="listaCzujnikow">
      <option disabled selected>-- wybierz --</option>
    </select>

    <div style="margin-top: 20px;">
      <label for="typWykresu">Typ wykresu:</label>
      <select id="typWykresu">
        <option value="minutowy">Minutowy (5-min)</option>
        <option value="dzienny">Dzienny (średnie)</option>
        <option value="zakres">Zakres od–do</option>
      </select>

      <label for="od">Od:</label>
      <input type="datetime-local" id="od">

      <label for="do">Do:</label>
      <input type="datetime-local" id="do">

      <button onclick="generujWykres()">Generuj wykres</button>
	  <button onclick="eksportujWykres()">Eksportuj do PNG</button>
    </div>

    <canvas id="wykres" width="800" height="400" style="margin-top: 30px;"></canvas>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJB3DxLtFFOvC2OpTxLAbpr4rJUfCyOwo",
      authDomain: "projekt-sp.firebaseapp.com",
      databaseURL: "https://projekt-sp-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "projekt-sp",
      storageBucket: "projekt-sp.firebasestorage.app",
      messagingSenderId: "485520309533",
      appId: "1:485520309533:web:cbf484593a3df15c58f5f4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const select = document.getElementById("listaCzujnikow");
    let wykres = null;

    db.ref("czujniki").once("value", (snapshot) => {
      const czujniki = snapshot.val();
      for (let id in czujniki) {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = id;
        select.appendChild(option);
      }
    });

    function generujWykres() {
      const czujnikId = select.value;
      const typ = document.getElementById("typWykresu").value;
      const od = new Date(document.getElementById("od").value);
      const do_ = new Date(document.getElementById("do").value);

      if (!czujnikId || isNaN(od) || isNaN(do_)) {
        alert("Wybierz czujnik i poprawny zakres czasu.");
        return;
      }

      const czujnikRef = db.ref("czujniki/" + czujnikId);
      czujnikRef.once("value", (snapshot) => {
        const dane = snapshot.val();
        if (!dane) return;

        const pomiary = Object.values(dane)
          .filter(p => {
            const t = new Date(p.timestamp);
            return t >= od && t <= do_;
          });

        if (pomiary.length === 0) {
          alert("Brak danych w wybranym zakresie.");
          return;
        }

        if (typ === "minutowy" || typ === "zakres") {
          const czasy = pomiary.map(p => new Date(p.timestamp));
          const temperatury = pomiary.map(p => p.temperatura);
          const wilgotnosci = pomiary.map(p => p.wilgotnosc);
          rysujWykresCzasowy(czasy, temperatury, wilgotnosci, od, do_);
        } else {
          const agregaty = agregujDziennie(pomiary);
          const czasy = agregaty.map(p => new Date(p.dzien));
          const temperatury = agregaty.map(p => p.temp);
          const wilgotnosci = agregaty.map(p => p.wilg);
          rysujWykresCzasowy(czasy, temperatury, wilgotnosci, od, do_);
        }
      });
    }

    function agregujDziennie(pomiary) {
      const grupy = {};
      pomiary.forEach(p => {
        const dzien = p.timestamp.split("T")[0];
        if (!grupy[dzien]) grupy[dzien] = [];
        grupy[dzien].push(p);
      });

      return Object.entries(grupy).map(([dzien, lista]) => {
        const temps = lista.map(p => p.temperatura);
        const wilgs = lista.map(p => p.wilgotnosc);
        const srednia = arr => +(arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);
        return { dzien, temp: srednia(temps), wilg: srednia(wilgs) };
      });
    }

    function rysujWykresCzasowy(czasy, temperatury, wilgotnosci, od, do_) {
      const ctx = document.getElementById('wykres').getContext('2d');
      if (wykres) wykres.destroy();

      const daneTemp = czasy.map((czas, i) => ({ x: czas, y: temperatury[i] }));
      const daneWilg = czasy.map((czas, i) => ({ x: czas, y: wilgotnosci[i] }));

      wykres = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Temperatura (°C)',
              data: daneTemp,
              borderColor: '#ff6384',
              fill: false
            },
            {
              label: 'Wilgotność (%)',
              data: daneWilg,
              borderColor: '#36a2eb',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: {
              type: 'time',
              min: od,
              max: do_,
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'HH:mm'
                }
              },
              title: {
                display: true,
                text: 'Czas pomiaru'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Wartość'
              }
            }
          }
        }
      });
    }
	function eksportujWykres() {
  const canvas = document.getElementById("wykres");
  const link = document.createElement("a");
  link.download = "wykres.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}
  </script>
</body>
</html>		