<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dane pomiarowe</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Dane pomiarowe</h1>
    <nav>
      <ul>
        <li><a href="index.html">Strona główna</a></li>
        <li><a href="czujniki.html">Dostępne urządzenia</a></li>
        <li><a href="dane.html">Dane pomiarowe</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>Wybierz czujnik</h2>
    <select id="listaCzujnikow">
      <option disabled selected>-- wybierz --</option>
    </select>

    <div style="margin-top: 20px;">
      <label for="typWykresu">Typ wykresu:</label>
      <select id="typWykresu">
        <option value="minutowy">Minutowy (5-min)</option>
        <option value="dzienny">Dzienny (średnie)</option>
        <option value="tygodniowy">Tygodniowy</option>
        <option value="miesieczny">Miesięczny</option>
        <option value="zakres">Zakres od–do</option>
      </select>

      <label for="od">Od:</label>
      <input type="datetime-local" id="od">

      <label for="do">Do:</label>
      <input type="datetime-local" id="do">

      <button onclick="generujWykres()">Generuj wykres</button>
    </div>

    <canvas id="wykres" width="800" height="400" style="margin-top: 30px;"></canvas>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "TWOJE_API_KEY",
      authDomain: "projekt-sp.firebaseapp.com",
      databaseURL: "https://projekt-sp-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "projekt-sp",
      storageBucket: "projekt-sp.appspot.com",
      messagingSenderId: "TWOJE_ID",
      appId: "TWOJE_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const select = document.getElementById("listaCzujnikow");
    let wykres = null;

    // Załaduj listę czujników
    db.ref("czujniki").once("value", (snapshot) => {
      const czujniki = snapshot.val();
      for (let id in czujniki) {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = id;
        select.appendChild(option);
      }
    });

    function generujWykres() {
      const czujnikId = select.value;
      const typ = document.getElementById("typWykresu").value;
      const od = document.getElementById("od").value;
      const do_ = document.getElementById("do").value;

      if (!czujnikId || !od || !do_) {
        alert("Wybierz czujnik i zakres czasu.");
        return;
      }

      const czujnikRef = db.ref("czujniki/" + czujnikId);
      czujnikRef.once("value", (snapshot) => {
        const dane = snapshot.val();
        if (!dane) return;

        const pomiary = Object.entries(dane)
          .filter(([ts]) => {
            const t = new Date(ts.replace(/_/g, ":"));
            return t >= new Date(od) && t <= new Date(do_);
          })
          .map(([ts, val]) => ({ ts, ...val }));

        if (typ === "minutowy" || typ === "zakres") {
          const labels = pomiary.map(p => p.ts.replace("T", " ").replace(/_/g, ":"));
          const temperatury = pomiary.map(p => p.temperatura);
          const wilgotnosci = pomiary.map(p => p.wilgotnosc);
          rysujWykres(labels, temperatury, wilgotnosci);
        } else {
          const agregaty = agregujDziennie(pomiary);
          const labels = agregaty.map(p => p.dzien);
          const temperatury = agregaty.map(p => p.temp);
          const wilgotnosci = agregaty.map(p => p.wilg);
          rysujWykres(labels, temperatury, wilgotnosci);
        }
      });
    }

    function agregujDziennie(pomiary) {
      const grupy = {};
      pomiary.forEach(p => {
        const dzien = p.ts.split("T")[0];
        if (!grupy[dzien]) grupy[dzien] = [];
        grupy[dzien].push(p);
      });

      return Object.entries(grupy).map(([dzien, lista]) => {
        const temps = lista.map(p => p.temperatura);
        const wilgs = lista.map(p => p.wilgotnosc);
        const srednia = arr => +(arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);
        return { dzien, temp: srednia(temps), wilg: srednia(wilgs) };
      });
    }

    function rysujWykres(labels, temperatury, wilgotnosci) {
      const ctx = document.getElementById('wykres').getContext('2d');
      if (wykres) wykres.destroy();

      wykres = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Temperatura (°C)',
              data: temperatury,
              borderColor: '#ff6384',
              fill: false
            },
            {
              label: 'Wilgotność (%)',
              data: wilgotnosci,
              borderColor: '#36a2eb',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: { title: { display: true, text: 'Czas pomiaru' } },
            y: { title: { display: true, text: 'Wartość' } }
          }
        }
      });
    }
  </script>
</body>
</html>