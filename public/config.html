<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="mini-logo.png">
    <title>Konfiguracja Progów - Monitoring temperatury</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>System monitoringu temperatury i wilgotności</h1>
        <nav>
            <ul>
                <li><a href="index.html">Strona główna</a></li>
                <li><a href="czujniki.html">Dostępne urządzenia</a></li>
                <li><a href="dane.html">Dane pomiarowe</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="config-section">
            <h2>Konfiguracja Progów dla Pomieszczeń</h2>
            <div id="config-content">
                <p class="loading-message">Ładowanie konfiguracji...</p>
            </div>
            <div id="auth-status-message"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Marek – Projekt SP</p>
    </footer>

    <!-- Firebase SDK Scripts -->
    <script type="module">
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
		  apiKey: "AIzaSyAJB3DxLtFFOvC2OpTxLAbpr4rJUfCyOwo",
		  authDomain: "projekt-sp.firebaseapp.com",
		  databaseURL: "https://projekt-sp-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "projekt-sp",
		  storageBucket: "projekt-sp.firebasestorage.app",
		  messagingSenderId: "485520309533",
		  appId: "1:485520309533:web:cbf484593a3df15c58f5f4",
		  measurementId: "G-STCT52Y98E"
		};


        // 2. Importowanie niezbędnych modułów Firebase
        // Zmienione ścieżki importu na bezpośrednie z CDN!
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";


        // 3. Inicjalizacja Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // 4. Referencje do elementów UI
        const configContent = document.getElementById('config-content');
        const authStatusMessage = document.getElementById('auth-status-message');

        let roomSettingsData = {}; // Przechowamy tutaj bieżące ustawienia progów

        // 5. Nasłuchiwanie na stan uwierzytelnienia
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Użytkownik zalogowany - możemy ładować i edytować konfigurację
                authStatusMessage.innerHTML = ''; // Usuń ewentualne komunikaty o braku autentykacji
                loadRoomConfigurations();
            } else {
                // Użytkownik niezalogowany - przekieruj na stronę logowania
                configContent.innerHTML = ''; // Ukryj zawartość konfiguracji
                authStatusMessage.innerHTML = `
                    <p class="unauthenticated-message">
                        Aby edytować progi, musisz być zalogowany. 
                        <a href="login.html">Przejdź do strony logowania.</a>
                    </p>
                `;
            }
        });

        // 6. Funkcja do ładowania i wyświetlania konfiguracji pomieszczeń
        function loadRoomConfigurations() {
            const roomSettingsRef = ref(database, 'roomSettings');
            onValue(roomSettingsRef, (snapshot) => {
                configContent.innerHTML = ''; // Czyścimy zawartość przed wstawieniem nowych formularzy
                roomSettingsData = snapshot.val(); // Zapisz aktualne dane
                
                if (roomSettingsData) {
                    Object.keys(roomSettingsData).forEach(roomName => {
                        const settings = roomSettingsData[roomName];
                        createRoomConfigForm(roomName, settings);
                    });
                } else {
                    configContent.innerHTML = '<p class="no-rooms-message">Brak skonfigurowanych pomieszczeń. Dodaj ręcznie w konsoli Firebase lub zaimplementuj dodawanie nowych.</p>';
                }
            }, (error) => {
                console.error("Błąd odczytu konfiguracji pomieszczeń:", error);
                configContent.innerHTML = '<p class="message error">Błąd podczas ładowania konfiguracji progów.</p>';
            });
        }

        // 7. Funkcja do tworzenia formularza konfiguracji dla danego pomieszczenia
        function createRoomConfigForm(roomName, settings) {
            const configCard = document.createElement('div');
            configCard.classList.add('config-card');
            configCard.setAttribute('data-room-name', roomName); // Użyj atrybutu dla łatwej identyfikacji

            configCard.innerHTML = `
                <h3>${roomName}</h3>
                <div class="form-field">
                    <label for="${roomName}-tempMin">Temp. Min (°C):</label>
                    <input type="number" id="${roomName}-tempMin" value="${settings.tempMin !== undefined ? settings.tempMin : ''}" step="0.1">
                </div>
                <div class="form-field">
                    <label for="${roomName}-tempMax">Temp. Max (°C):</label>
                    <input type="number" id="${roomName}-tempMax" value="${settings.tempMax !== undefined ? settings.tempMax : ''}" step="0.1">
                </div>
                <div class="form-field">
                    <label for="${roomName}-humMin">Wilgotność Min (%):</label>
                    <input type="number" id="${roomName}-humMin" value="${settings.humMin !== undefined ? settings.humMin : ''}" step="1">
                </div>
                <div class="form-field">
                    <label for="${roomName}-humMax">Wilgotność Max (%):</label>
                    <input type="number" id="${roomName}-humMax" value="${settings.humMax !== undefined ? settings.humMax : ''}" step="1">
                </div>
                <button class="save-button" data-room-name="${roomName}">Zapisz ${roomName}</button>
                <div id="message-${roomName}" class="message" style="display: none;"></div>
            `;
            configContent.appendChild(configCard);

            // Dodajemy event listener do przycisku "Zapisz"
            configCard.querySelector(`.save-button[data-room-name="${roomName}"]`).addEventListener('click', (event) => {
                saveRoomSettings(roomName, event.target.nextElementSibling); // Przekazujemy element wiadomości
            });
        }

        // 8. Funkcja do zapisywania ustawień dla danego pomieszczenia
        async function saveRoomSettings(roomName, messageElement) {
            const tempMin = parseFloat(document.getElementById(`${roomName}-tempMin`).value);
            const tempMax = parseFloat(document.getElementById(`${roomName}-tempMax`).value);
            const humMin = parseFloat(document.getElementById(`${roomName}-humMin`).value);
            const humMax = parseFloat(document.getElementById(`${roomName}-humMax`).value);

            const updates = {
                tempMin: isNaN(tempMin) ? null : tempMin,
                tempMax: isNaN(tempMax) ? null : tempMax,
                humMin: isNaN(humMin) ? null : humMin,
                humMax: isNaN(humMax) ? null : humMax,
            };

            try {
                // Używamy update, aby zaktualizować tylko zmienione pola w Realtime Database
                await update(ref(database, `roomSettings/${roomName}`), updates);
                showMessage(messageElement, 'Konfiguracja zapisana pomyślnie!', 'success');
            } catch (error) {
                console.error("Błąd zapisu konfiguracji:", error);
                showMessage(messageElement, `Błąd zapisu: ${error.message}`, 'error');
            }
        }

        // 9. Funkcja do wyświetlania komunikatów
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message ${type}`; // Zresetuj klasy i dodaj nowe
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000); // Ukryj wiadomość po 3 sekundach
        }
    </script>
</body>
</html>
